---
layout: default
title: Build And Push - Voldemort
---


<h1>Build & Push Jobs for Voldemort Read-Only</h1>

<h2>Introduction </h2>

<p>We have been using the Build and Push Job at Linkedin to create Voldemort Read-Only stores from data present in sequence files/ Avro Container files on HDFS.
  The Voldemort build and push job uses the fault tolerance and parallelism of Hadoop and builds individual Voldemort node/partition-level data stores, which are transferred to Voldemort for serving.
  A Hadoop job reads data from a source in HDFS, repartitions it on a per-node basis, and ﬁnally writes the data to individual Read-only storage engine [1].
</p>
<p>
  The VoldemortBuildAndPushJob will behave in the following way:
</p>
  <ol>
    <li>Build an XML storeDef for your data (based off of the key and value metadata in your JsonSequenceFile/Avro on HDFS).</li>
    <li>Connect to push.cluster</li>
    <li>Get the storeDefs for all stores in the push.cluster</li>
    <li>Look through the storeDefs for a store with the same name as push.store.name. If one is found, validate that the storeDef in the cluster matches the storeDef for your data. If it doesn’t, fail. If no storeDef exists on the cluster that matches push.store.name,
	then add your storeDef to the cluster.</li>
    <li>Build the Voldemort store in Hadoop</li>
    <li>Push the Voldemort store to push.cluster</li>
  </ol>

<h4>Getting Started</h4>
<p>First, you should clone and build the latest version of Voldemort, as described in the <a href="quickstart.html">Quickstart</a> guide. The "server.properties" file on the Voldemort server needs to have the following entry:</p>
<div style="background: #f8f8f8; overflow:auto;width:auto;color:black;background:white;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
	<pre style="margin: 0; line-height: 125%">file.fetcher.class=voldemort.store.readonly.fetcher.HdfsFetcher</pre></div>
<p>This instructs the server to use that class while fetching files from Hadoop during the push phase.</p>

<p>Then, from the root of the Voldemort git repository, you can generate a fat jar containing all of the dependencies that the Build and Push job needs with the following command:</p>
<pre>
	./gradlew bnpJar
</pre>

<p>After that, you can launch the BnP job from your local machine using the following command:</p>
<pre>
	./bin/run-bnp.sh &lt;config_file&gt;
</pre>

<p>The config_file argument should point to the path of a text file containing configuration parameters for the BnP job. Below are two such example configurations.</p>

<h4>Pushing JSON Data - Job File</h4>

<!-- HTML generated using hilite.me -->
<div style="background: #f8f8f8; overflow:auto;width:auto;color:black;background:white;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
	<pre style="margin: 0; line-height: 125%">type=java
job.class=voldemort.store.readonly.mr.azkaban.VoldemortBuildAndPushJob
hadoop.job.ugi=anagpal,hadoop
build.input.path=/tmp/new_op
build.output.dir=/tmp/build_output/
push.store.name=anagpal-test-old
push.cluster=tcp://localhost:6666
push.store.description="test store"
push.store.owners=myemail@myworkplace.com
build.replication.factor=1</pre>
</div>


<h4>Pushing AVRO Data - Job File</h4>

<div style="background: #f8f8f8; overflow:auto;width:auto;color:black;background:white;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
	<pre style="margin: 0; line-height: 125%">type=java
job.class=voldemort.store.readonly.mr.azkaban.VoldemortBuildAndPushJob
build.input.path=/user/anagpal/avro-data
build.output.dir=/tmp
push.cluster=tcp://localhost:6666
azkaban.should.proxy=true
user.to.proxy= anagpal
build.replication.factor= 1
build.type.avro=true
build.output.dir=/tmp/
avro.key.field=memberId
avro.value.field=localizedFirstNames
push.store.name=test-avro-store
push.store.description="Testing avro build and push"
push.store.owners= myemail@myworkplace.com
build.input.path=/user/anagpal/avro-data
build.output.dir=/tmp</pre>
</div>

<p>Notice the following properties:</p>
<ol>
  <li>build.type.avro=true This specifies that input data is Avro.</li>
  <li>avro.key.field=memberId This specifies the field to be used as the key</li>
  <li>avro.value.field=localizedFirstNames This specifies the field to be used as the value</li>
</ol>

<h4>File Format</h4>

<p>We use a custom data and index format for the Read-Only store.</p>
<p>On every Node you will find a node directory containing one or mutliple data and index files with the following naming convention:</p>
<!-- HTML generated using hilite.me -->
<div style="background: #f8f8f8; overflow:auto;width:auto;color:black;background:white;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
  <pre style="margin: 0; line-height: 125%">partition_id.replica_id.chunkset_id</pre>
</div>

<h4>Troubleshooting</h4>

If you have any issues with Voldemort Read-Only or the BnP job, please reach out to the open-source community on the <a href="https://groups.google.com/forum/#!forum/project-voldemort">Voldemort mailing list</a>.

<h4>References</h4>

<ol>
    <li><a href="http://static.usenix.org/events/fast12/tech/full_papers/Sumbaly.pdf">Serving Large-scale Batch Computed Data with Project Voldemort</a></li>
    <li><a href="http://azkaban.github.io/azkaban/docs/latest/#voldemortbuildandpush-type">Configuring the Build and Push job as an Azkaban plugin</a></li>
</ol>
